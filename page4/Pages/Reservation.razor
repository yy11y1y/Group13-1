@page "/reservation"
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<div class="title-container">
    <h1 class="page-title">化療預約系統</h1>
</div>

<div class="menu-container">
    <div class="menu-option selected">填寫資料</div>
    <div class="menu-option">選擇化療時段</div>
    <div class="menu-option selected">預約完成</div>
</div>

<div class="mt-3">
    <label for="selectedDate" class="btn-bed">選擇日期</label>
    <div class="color-box" style="background-color: #d9d9d9;"></div> ：今日
    <div class="color-box" style="background-color: #c5c2c2;"></div> ：已額滿
    <div class="color-box" style="background-color: #7188ba;"></div> ：可選擇
    <div class="color-box" style="background-color: #45539d;"></div> ：已選擇
</div>

<div>
    <input type="text" placeholder="@GetPlaceholderText()" @onclick="ToggleCalendar" readonly class="custom-input" />
</div>

<div>
    <span class="arrow" @onmouseover="() => ArrowHover(true)" @onmouseout="() => ArrowHover(false)" @onclick="() => ChangeMonth(-1)">❮</span>
    <span class="month-year">@currentDate.ToString("MMMM yyyy")</span>
    <span class="arrow" @onmouseover="() => ArrowHover(true)" @onmouseout="() => ArrowHover(false)" @onclick="() => ChangeMonth(1)">❯</span>
</div>

<div id="calendar-container" style="calendar-container;">
    <table>
        <thead>
            <tr>
                <th>Sun</th>
                <th>Mon</th>
                <th>Tue</th>
                <th>Wed</th>
                <th>Thu</th>
                <th>Fri</th>
                <th>Sat</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < 6; i++)
            {
                <tr>
                    @for (int j = 0; j < 7; j++)
                    {
                        var daysInMonth = DateTime.DaysInMonth(currentDate.Year, currentDate.Month);
                        var day = i * 7 + j + 1 - (int)new DateTime(currentDate.Year, currentDate.Month, 1).DayOfWeek;
                        var currentDay = day >= 1 && day <= daysInMonth
                        ? new DateTime(currentDate.Year, currentDate.Month, day)
                        : (DateTime?)null;

                        <td class="@(currentDay?.Month != currentDate.Month ? "other-month" : "") @(currentDay?.Date == currentDate.Date ? "today" : "")">
                            @if (currentDay.HasValue)
                            {
                                <button @onclick="() => SelectDate(currentDay.Value)" class="date-button @(selectedDate == currentDay ? "selected" : "")">
                                    @currentDay.Value.Day
                                </button>
                            }
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="mt-3">
    <p class="btn-bed">選擇床段</p>
    <p>每半小時一個床段，若需要選擇多個床段，請選擇相鄰時段。</p>
</div>

@foreach (var bed in new[] { "A", "B", "C" })
{
    var tempBed = bed;
    <div style="margin-bottom: 10px;">
        <button class="bed-button" @onclick="() => ToggleMenu(tempBed)">病床 @tempBed</button>
        @if (IsMenuVisible(tempBed))
        {
            <div id="menu">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 90%;">時段</th>
                            <th style="width: 10%;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var timeSlot in TimeSlots)
                        {
                            <tr @onclick="() => ToggleCheckbox(tempBed, timeSlot)" class="@RowStyle(tempBed, timeSlot)">
                                <td style="color: @(checkboxDictionaries[tempBed][timeSlot] ? "white" : "black")">@timeSlot</td>
                                <td><input type="checkbox" @bind="checkboxDictionaries[tempBed][timeSlot]" /></td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div style="text-align: center;">
                    <button @onclick="() => ConfirmSelection(tempBed)">確認</button>
                </div>
            </div>
        }
    </div>
}

<!-- 月历控件 -->
<div id="datepicker" style="display: none;"></div>

<div class="mt-3 text-center">
    <button class="btn btn-primary" @onclick="GoToRecord">
        上一步
    </button>
    <button class="btn btn-primary" @onclick="GoToHomePage">
        回首頁
    </button>
    <button class="btn btn-primary" @onclick="GoToNextStep">
        下一步
    </button>
</div>
<br />
<br />

@code {

    private DateTime currentDate = DateTime.Now;
    private DateTime? selectedDate;

    private string GetPlaceholderText()
    {
        return selectedDate?.ToString("yyyy/MM/dd") ?? "請點選未來一個月內預約日期";
    }

    private void ChangeMonth(int offset)
    {
        currentDate = currentDate.AddMonths(offset);
        JSRuntime.InvokeVoidAsync("scrollToCalendar");
    }

    private void ToggleCalendar()
    {
        // Implement your logic to show/hide the calendar
    }

    private void SelectDate(DateTime date)
    {
        if (selectedDate == date)
        {
            selectedDate = null; // 取消選擇
        }
        else
        {
            selectedDate = date;
        }
    }

    private bool isArrowHovered = false;

    private void ArrowHover(bool isHovered)
    {
        isArrowHovered = isHovered;
    }

    private Dictionary<string, Dictionary<string, bool>> checkboxDictionaries;

    private Dictionary<string, List<string>> selectedTimeSlots = new Dictionary<string, List<string>>();

    private List<string> TimeSlots = new List<string>
{
        "09:00-09:30", "09:30-10:00", "10:00-10:30", "10:30-11:00",
        "11:00-11:30", "11:30-12:00", "12:00-12:30", "12:30-13:00",
        "13:00-13:30", "13:30-14:00", "14:00-14:30", "14:30-15:00",
        "15:00-15:30", "15:30-16:00", "16:00-16:30", "16:30-17:00"
    };


    protected override void OnInitialized()
    {
        checkboxDictionaries = null; // 菜單一開始是隱藏的
        selectedTimeSlots = new Dictionary<string, List<string>>();
    }

    private bool IsMenuVisible(string bed)
    {
        return checkboxDictionaries != null && checkboxDictionaries.ContainsKey(bed);
    }

    private string RowStyle(string bed, string timeSlot)
    {
        return checkboxDictionaries != null && checkboxDictionaries[bed][timeSlot] ? "selected" : "";
    }

    private void ToggleMenu(string bed)
    {
        if (IsMenuVisible(bed))
        {
            // 如果菜單已經打開，更新 checkboxDictionaries 以反映上次的選擇
            checkboxDictionaries = new Dictionary<string, Dictionary<string, bool>>();
            checkboxDictionaries[bed] = new Dictionary<string, bool>();
            foreach (var timeSlot in TimeSlots)
            {
                checkboxDictionaries[bed][timeSlot] = selectedTimeSlots.ContainsKey(bed) && selectedTimeSlots[bed].Contains(timeSlot);
            }
        }
        else
        {
            // 顯示指定床位的菜單
            checkboxDictionaries = new Dictionary<string, Dictionary<string, bool>>();
            selectedTimeSlots[bed] = new List<string>();
            checkboxDictionaries[bed] = new Dictionary<string, bool>();
            foreach (var timeSlot in TimeSlots)
            {
                checkboxDictionaries[bed][timeSlot] = selectedTimeSlots.ContainsKey(bed) && selectedTimeSlots[bed].Contains(timeSlot);
            }
        }
    }

    private void ToggleCheckbox(string bed, string timeSlot)
    {
        if (checkboxDictionaries != null)
        {
            checkboxDictionaries[bed][timeSlot] = !checkboxDictionaries[bed][timeSlot];
        }
    }

    private void ConfirmSelection(string bed)
    {
        // 處理確認按鈕的邏輯
        Console.WriteLine($"床位: {bed}");
        selectedTimeSlots[bed] = new List<string>();

        foreach (var timeSlot in TimeSlots)
        {
            if (checkboxDictionaries[bed][timeSlot])
            {
                Console.WriteLine($"選擇了時間段: {timeSlot}");
                selectedTimeSlots[bed].Add(timeSlot);
            }
        }

        // 移除床位對應的菜單
        checkboxDictionaries = null;
    }

    private async Task ShowDatePicker()
    {
        await JSRuntime.InvokeVoidAsync("ShowDatePicker");
    }
    private void GoToRecord()
    {
        NavigationManager.NavigateTo("/record");
    }
    private void GoToHomePage()
    {
        NavigationManager.NavigateTo("/");
    }

    private void GoToNextStep()
    {
        NavigationManager.NavigateTo("/finish");
    }


}

<style>
    .title-container {
        background-color: #acc7d0;
        text-align: center;
        padding: 80px;
        margin-bottom: 50px;
        margin-top: 0;

    }

    .page-title {
        font-size: 3em;
        font-weight: bold;
        padding: 10px;
        display: inline-block;
    }

    .menu-container {
        display: flex;
        justify-content: space-around;
        background-color: #91a9b1;
        padding: 20px;
        margin-left: 60px;
        margin-right: 60px;
    }

    .menu-option {
        flex-grow: 1;
        position: relative;
        background-color: white;
        padding: 25px;
        cursor: pointer;
        margin: 10 15px;
        font-size: 1.5em;
        font-weight: bold;
        color: #000000;
        text-align: center;
        clip-path: polygon(0% 0%, 10% 50%, 0% 100%, 90% 100%, 100% 50%, 90% 0%);
    }

    .selected {
        background-color: #c0cfd3;
        color: #91a9b1;
    }

    .mt-3 {
        margin-top: 1.5rem;
    }

    .btn-bed {
        font-size: 1.5em; /* 調整字體大小 */
        font-weight: bold;
        background-color: lightgray;
        display: inline-block; /* 使文本和框框處於同一行 */
        padding: 10px; /* 調整內側 padding */
    }


    .date-picker-container {
        position: relative;
    }

        .date-picker-container .datepicker {
            width: 600px !important;
            height: 600px !important;
            z-index: 9999;
            font-size: 16px;
        }

    .button-container {
        display: flex;
        flex-direction: column;
    }

        .button-container div {
            margin-bottom: 10px;
        }

    #menu table {
        width: 100%;
        border-collapse: collapse;
    }

    #menu th,
    #menu td {
        padding: 8px;
        border: none;
    }

    #menu input[type="checkbox"] {
        cursor: pointer;
        width: 16px;
        height: 16px;
    }

    #menu tr:not(:first-child):hover {
        background-color: #f0f0f0;
    }

    #menu tr.selected {
        background-color: #45539d;
    }

    #menu button {
        margin-top: 10px;
    }

    #menu th:first-child,
    #menu td:first-child {
        text-align: left;
    }

    #menu tr.selected:hover {
        background-color: #45539d;
    }

    .text-center {
        text-align: center;
    }

    .card-container {
        display: inline-block;
        padding: 20px;
        border: 1px solid #ccc;
    }

    .flex-container {
        display: flex;
        justify-content: center;
    }

    .card {
        width: 200px;
        margin: 10px;
    }

    .bed-button {
        background-color: #d9d9d9;
        border: none;
        padding: 10px;
        cursor: pointer;
        margin: 0;
        font-weight: bold;
        font-size: 1.2em;
    }

    .color-box {
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-right: 5px;
        border: 1px solid #000; /* 可以根據需要添加邊框 */
    }

    .btn {
        background-color: #e1e7ea; /* 水藍色背景 */
        color: black;
        border: 0.5px solid black; /* 黑色細框 */
        border-radius: 12px; /* 圓邊 */
        padding: 2px 5px; /* 調整按鈕內容與邊框的距離 */
        margin: 0 15px; /* 調整按鈕之間的間距 */
        cursor: pointer;
    }


    .arrow {
        cursor: pointer;
        color: @(isArrowHovered ? "red" : "inherit");
    }

    .month-year {
        margin: 0 10px;
    }

    table {
        width: 70%;
        margin: 20px auto;
        border-collapse: collapse;/* 靠左 */
    }

    .calendar-container {
        clear: both;
        text-align: left; /* 將文本靠左對齊 */
    }

    th, td {
        padding: 0px;
        text-align: center;
        border: 1px solid #ddd;
        width: 14.2857%;
    }

    th {
        background-color: #f2f2f2;
    }

    td {
        height: 80px;
    }

    .today .date-button {
        background-color: #d9d9d9; /* 今日日期格子為綠色 */
    }

    .other-month {
        color: #aaa;
    }

    .date-button {
        background-color: inherit;
        border: none;
        cursor: pointer;
        width: 100%;
        height: 100%; /* 調整高度 */
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .date-button:hover {
            background-color: #828cc0; /* 箭頭經過時紅色 */
        }

        .date-button.selected {
            background-color: #45539d; /* 點擊後保持藍色 */
        }

    input {
        margin-top: 10px;
        padding: 5px;
    }

    .custom-input {
        width: 30%;
        padding: 10px;
    }
</style>